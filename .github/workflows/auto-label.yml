name: Auto-label Issues
on:
  issues:
    types: [opened]

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Parse issue and apply labels
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = context.payload.issue.body;
            const labelsToAdd = [];

            // 1. Detectar ENTREGABLE (T1, T2, T3)
            const deliverableMatch = issueBody.match(/Entregable objetivo:\s*\*\*(T\d)/);
            if (deliverableMatch) {
              labelsToAdd.push(deliverableMatch[1]);
            }

            // 2. Detectar ÁREA (DF, DA, P, SQL, PBI)
            const areaMatch = issueBody.match(/Área de trabajo:\s*\*\*(\w{2,3})/);
            if (areaMatch) {
              labelsToAdd.push(areaMatch[1]);
            }

            // 3. Detectar TIPO DE TAREA (Analysis, Code, etc.)
            const taskMatch = issueBody.match(/Tipo de tarea:\s*\*\*(\w+)/);
            if (taskMatch) {
              labelsToAdd.push(taskMatch[1]);
            }

            // 4. Detectar TIPO DE ISSUE (Task, Bug, Enhancement)
            const typeMatch = issueBody.match(/Tipo de issue:\s*\*\*(\w+)/);
            if (typeMatch) {
              labelsToAdd.push(taskMatch[1]);
            }

            // Aplicar labels si se encontraron
            if (labelsToAdd.length > 0) {
              console.log(`Aplicando labels: ${labelsToAdd.join(', ')}`);
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labelsToAdd
              });
            }
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
